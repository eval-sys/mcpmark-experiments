{
  "task_id": "customer_analytics_optimization",
  "task_name": "Customer Analytics Optimization",
  "category_id": "dvdrental",
  "category_name": "DVD Rental",
  "description": "Optimize slow customer analytics query with correlated subqueries causing timeout issues in reporting dashboard.",
  "author": "Lingxiao Du",
  "created_at": "2025-08-20",
  "difficulty": "L3",
  "tags": [
    "performance optimization"
  ],
  "mcp": [
    "postgres"
  ],
  "meta_data": {
    "stateType": "text",
    "stateContent": "Enum \"mpaa_rating\" {\n  \"G\"\n  \"PG\"\n  \"PG-13\"\n  \"R\"\n  \"NC-17\"\n}\n\nTable \"customer\" {\n  \"customer_id\" int4 [pk, not null, increment]\n  \"store_id\" int2 [not null]\n  \"first_name\" varchar(45) [not null]\n  \"last_name\" varchar(45) [not null]\n  \"email\" varchar(50)\n  \"address_id\" int2 [not null]\n  \"activebool\" bool [not null, default: true]\n  \"create_date\" date [not null, default: `('now'::text)::date`]\n  \"last_update\" timestamp [default: `now()`]\n  \"active\" int4\n\n  Indexes {\n    address_id [type: btree, name: \"idx_fk_address_id\"]\n    store_id [type: btree, name: \"idx_fk_store_id\"]\n    last_name [type: btree, name: \"idx_last_name\"]\n  }\n}\n\nTable \"actor\" {\n  \"actor_id\" int4 [pk, not null, increment]\n  \"first_name\" varchar(45) [not null]\n  \"last_name\" varchar(45) [not null]\n  \"last_update\" timestamp [not null, default: `now()`]\n\n  Indexes {\n    last_name [type: btree, name: \"idx_actor_last_name\"]\n  }\n}\n\nTable \"category\" {\n  \"category_id\" int4 [pk, not null, increment]\n  \"name\" varchar(25) [not null]\n  \"last_update\" timestamp [not null, default: `now()`]\n}\n\nTable \"film\" {\n  \"film_id\" int4 [pk, not null, increment]\n  \"title\" varchar(255) [not null]\n  \"description\" text\n  \"release_year\" int4\n  \"language_id\" int2 [not null]\n  \"rental_duration\" int2 [not null, default: 3]\n  \"rental_rate\" numeric(4,2) [not null, default: 4.99]\n  \"length\" int2\n  \"replacement_cost\" numeric(5,2) [not null, default: 19.99]\n  \"rating\" mpaa_rating [default: 'G']\n  \"last_update\" timestamp [not null, default: `now()`]\n  \"special_features\" \"text[]\"\n  \"fulltext\" tsvector [not null]\n\n  Indexes {\n    fulltext [type: gist, name: \"film_fulltext_idx\"]\n    language_id [type: btree, name: \"idx_fk_language_id\"]\n    title [type: btree, name: \"idx_title\"]\n  }\n}\n\nTable \"film_actor\" {\n  \"actor_id\" int2 [not null]\n  \"film_id\" int2 [not null]\n  \"last_update\" timestamp [not null, default: `now()`]\n\n  Indexes {\n    (actor_id, film_id) [type: btree, name: \"film_actor_pkey\"]\n    film_id [type: btree, name: \"idx_fk_film_id\"]\n  }\n}\n\nTable \"film_category\" {\n  \"film_id\" int2 [not null]\n  \"category_id\" int2 [not null]\n  \"last_update\" timestamp [not null, default: `now()`]\n\n  Indexes {\n    (film_id, category_id) [type: btree, name: \"film_category_pkey\"]\n  }\n}\n\nTable \"address\" {\n  \"address_id\" int4 [pk, not null, increment]\n  \"address\" varchar(50) [not null]\n  \"address2\" varchar(50)\n  \"district\" varchar(20) [not null]\n  \"city_id\" int2 [not null]\n  \"postal_code\" varchar(10)\n  \"phone\" varchar(20) [not null]\n  \"last_update\" timestamp [not null, default: `now()`]\n\n  Indexes {\n    city_id [type: btree, name: \"idx_fk_city_id\"]\n  }\n}\n\nTable \"city\" {\n  \"city_id\" int4 [pk, not null, increment]\n  \"city\" varchar(50) [not null]\n  \"country_id\" int2 [not null]\n  \"last_update\" timestamp [not null, default: `now()`]\n\n  Indexes {\n    country_id [type: btree, name: \"idx_fk_country_id\"]\n  }\n}\n\nTable \"country\" {\n  \"country_id\" int4 [pk, not null, increment]\n  \"country\" varchar(50) [not null]\n  \"last_update\" timestamp [not null, default: `now()`]\n}\n\nTable \"inventory\" {\n  \"inventory_id\" int4 [pk, not null, increment]\n  \"film_id\" int2 [not null]\n  \"store_id\" int2 [not null]\n  \"last_update\" timestamp [not null, default: `now()`]\n\n  Indexes {\n    (store_id, film_id) [type: btree, name: \"idx_store_id_film_id\"]\n  }\n}\n\nTable \"language\" {\n  \"language_id\" int4 [pk, not null, increment]\n  \"name\" bpchar(20) [not null]\n  \"last_update\" timestamp [not null, default: `now()`]\n}\n\nTable \"payment\" {\n  \"payment_id\" int4 [pk, not null, increment]\n  \"customer_id\" int2 [not null]\n  \"staff_id\" int2 [not null]\n  \"rental_id\" int4 [not null]\n  \"amount\" numeric(5,2) [not null]\n  \"payment_date\" timestamp [not null]\n\n  Indexes {\n    rental_id [type: btree, name: \"idx_fk_rental_id\"]\n    staff_id [type: btree, name: \"idx_fk_staff_id\"]\n  }\n}\n\nTable \"rental\" {\n  \"rental_id\" int4 [pk, not null, increment]\n  \"rental_date\" timestamp [not null]\n  \"inventory_id\" int4 [not null]\n  \"customer_id\" int2 [not null]\n  \"return_date\" timestamp\n  \"staff_id\" int2 [not null]\n  \"last_update\" timestamp [not null, default: `now()`]\n\n  Indexes {\n    (rental_date, inventory_id, customer_id) [type: btree, name: \"idx_unq_rental_rental_date_inventory_id_customer_id\"]\n    inventory_id [type: btree, name: \"idx_fk_inventory_id\"]\n  }\n}\n\nTable \"staff\" {\n  \"staff_id\" int4 [pk, not null, increment]\n  \"first_name\" varchar(45) [not null]\n  \"last_name\" varchar(45) [not null]\n  \"address_id\" int2 [not null]\n  \"email\" varchar(50)\n  \"store_id\" int2 [not null]\n  \"active\" bool [not null, default: true]\n  \"username\" varchar(16) [not null]\n  \"password\" varchar(40)\n  \"last_update\" timestamp [not null, default: `now()`]\n  \"picture\" bytea\n}\n\nTable \"store\" {\n  \"store_id\" int4 [pk, not null, increment]\n  \"manager_staff_id\" int2 [unique, not null]\n  \"address_id\" int2 [not null]\n  \"last_update\" timestamp [not null, default: `now()`]\n}\n\nRef \"fk_address_city\":\"city\".\"city_id\" < \"address\".\"city_id\"\n\nRef \"fk_city\":\"country\".\"country_id\" < \"city\".\"country_id\"\n\nRef \"customer_address_id_fkey\":\"address\".\"address_id\" < \"customer\".\"address_id\" [update: cascade, delete: restrict]\n\nRef \"film_language_id_fkey\":\"language\".\"language_id\" < \"film\".\"language_id\" [update: cascade, delete: restrict]\n\nRef \"film_actor_actor_id_fkey\":\"actor\".\"actor_id\" < \"film_actor\".\"actor_id\" [update: cascade, delete: restrict]\n\nRef \"film_actor_film_id_fkey\":\"film\".\"film_id\" < \"film_actor\".\"film_id\" [update: cascade, delete: restrict]\n\nRef \"film_category_category_id_fkey\":\"category\".\"category_id\" < \"film_category\".\"category_id\" [update: cascade, delete: restrict]\n\nRef \"film_category_film_id_fkey\":\"film\".\"film_id\" < \"film_category\".\"film_id\" [update: cascade, delete: restrict]\n\nRef \"inventory_film_id_fkey\":\"film\".\"film_id\" < \"inventory\".\"film_id\" [update: cascade, delete: restrict]\n\nRef \"payment_customer_id_fkey\":\"customer\".\"customer_id\" < \"payment\".\"customer_id\" [update: cascade, delete: restrict]\n\nRef \"payment_rental_id_fkey\":\"rental\".\"rental_id\" < \"payment\".\"rental_id\" [update: cascade, delete: set null]\n\nRef \"payment_staff_id_fkey\":\"staff\".\"staff_id\" < \"payment\".\"staff_id\" [update: cascade, delete: restrict]\n\nRef \"rental_customer_id_fkey\":\"customer\".\"customer_id\" < \"rental\".\"customer_id\" [update: cascade, delete: restrict]\n\nRef \"rental_inventory_id_fkey\":\"inventory\".\"inventory_id\" < \"rental\".\"inventory_id\" [update: cascade, delete: restrict]\n\nRef \"rental_staff_id_key\":\"staff\".\"staff_id\" < \"rental\".\"staff_id\"\n\nRef \"staff_address_id_fkey\":\"address\".\"address_id\" < \"staff\".\"address_id\" [update: cascade, delete: restrict]\n\nRef \"store_address_id_fkey\":\"address\".\"address_id\" < \"store\".\"address_id\" [update: cascade, delete: restrict]\n\nRef \"store_manager_staff_id_fkey\":\"staff\".\"staff_id\" < \"store\".\"manager_staff_id\" [update: cascade, delete: restrict]\n",
    "stateUrl": null,
    "stateOriginalUrl": "https://github.com/gordonkwokkwok/DVD-Rental-PostgreSQL-Project"
  },
  "instruction": "Optimize slow customer analytics query in the DVD rental database.\n\n## Background\n\nThe business intelligence team is running customer analytics reports, but one of their critical queries has become extremely slow. The query that used to run in milliseconds is now taking over a second to complete, causing timeout issues in their reporting dashboard.\n\n## Your Task\n\nAnalyze and optimize the performance of this customer analytics query:\n\n```sql\nSELECT \n    c.customer_id,\n    c.first_name,\n    c.last_name,\n    c.email,\n    COUNT(DISTINCT p.payment_id) as total_payments,\n    SUM(p.amount) as total_spent,\n    AVG(p.amount) as avg_payment,\n    COUNT(DISTINCT EXTRACT(month FROM p.payment_date)) as active_months,\n    MAX(p.payment_date) as last_payment,\n    MIN(p.payment_date) as first_payment,\n    (SELECT COUNT(*) FROM payment p2 WHERE p2.customer_id = c.customer_id AND p2.amount > 5.0) as high_value_payments,\n    (SELECT SUM(amount) FROM payment p3 WHERE p3.customer_id = c.customer_id AND p3.payment_date >= '2007-03-01') as recent_spending\nFROM customer c\nJOIN payment p ON c.customer_id = p.customer_id\nWHERE c.active = 1\nGROUP BY c.customer_id, c.first_name, c.last_name, c.email\nHAVING COUNT(p.payment_id) >= 10\nORDER BY total_spent DESC, total_payments DESC;\n```\n\nThe query is currently taking over 1000ms to execute and has a very high cost in the execution plan. The team needs this optimized urgently as it's blocking their daily reporting processes.\n\n## Requirements\n\n- Use `EXPLAIN ANALYZE` to identify performance bottlenecks\n- Implement appropriate database optimizations  \n- Ensure queries return accurate results after optimization\n- Document your optimization approach and performance improvements",
  "verify": "\"\"\"\nVerification script for PostgreSQL Task 1: Customer Payment Query Optimization\n\"\"\"\n\nimport os\nimport sys\nimport psycopg2\n\ndef get_connection_params() -> dict:\n    \"\"\"Get database connection parameters.\"\"\"\n    return {\n        \"host\": os.getenv(\"POSTGRES_HOST\", \"localhost\"),\n        \"port\": int(os.getenv(\"POSTGRES_PORT\", 5432)),\n        \"database\": os.getenv(\"POSTGRES_DATABASE\"),\n        \"user\": os.getenv(\"POSTGRES_USERNAME\"),\n        \"password\": os.getenv(\"POSTGRES_PASSWORD\")\n    }\n\ndef check_payment_customer_id_index(conn) -> bool:\n    \"\"\"Check if there's any index on payment.customer_id column.\"\"\"\n    with conn.cursor() as cur:\n        cur.execute(\"\"\"\n            SELECT indexname, indexdef \n            FROM pg_indexes \n            WHERE schemaname = 'public' \n            AND tablename = 'payment'\n            AND indexdef LIKE '%customer_id%'\n        \"\"\")\n        indexes = cur.fetchall()\n        print(indexes)\n        return len(indexes) > 0, indexes\n\ndef main():\n    \"\"\"Main verification function.\"\"\"\n    print(\"=\" * 60)\n    print(\"PostgreSQL Task 1 Verification: Customer Payment Query Optimization\")\n    print(\"=\" * 60)\n    \n    # Get connection parameters\n    conn_params = get_connection_params()\n    \n    if not conn_params[\"database\"]:\n        print(\"❌ No database specified\")\n        sys.exit(1)\n    \n    try:\n        # Connect to database\n        conn = psycopg2.connect(**conn_params)\n        \n        print(\"\\n🔍 Checking for customer_id index on payment table...\")\n        \n        # Check if any index exists on payment.customer_id\n        has_index, indexes = check_payment_customer_id_index(conn)\n        \n        if has_index:\n            print(\"✅ Found index(es) on payment.customer_id:\")\n            for index_name, index_def in indexes:\n                print(f\"   - {index_name}: {index_def}\")\n        else:\n            print(\"❌ No index found on payment.customer_id column\")\n        \n        conn.close()\n        \n        if has_index:\n            print(f\"\\n🎉 Task verification: PASS\")\n            print(f\"   - Index on payment.customer_id exists\")\n            sys.exit(0)\n        else:\n            print(f\"\\n❌ Task verification: FAIL\")\n            print(f\"   - No index found on payment.customer_id\")\n            print(f\"   - Create an index on payment(customer_id) to optimize the queries\")\n            sys.exit(1)\n            \n    except psycopg2.Error as e:\n        print(f\"❌ Database error: {e}\")\n        sys.exit(1)\n    except Exception as e:\n        print(f\"❌ Verification error: {e}\")\n        sys.exit(1)\n\nif __name__ == \"__main__\":\n    main()"
}